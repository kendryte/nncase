# This file is generated by Nncase CPU module builder.

cmake_minimum_required(VERSION 3.15)

project(nncase_cpu_module)

option(BUILD_SHARED "Build shared library in linux" OFF)
option(BUILD_STANDALONE "Build standalone executable" OFF)
if(BUILD_STANDALONE)
  add_compile_definitions(-DNNCASE_STANDALONE=1)
endif()

include(@Html.Raw(Model.CMakePath))

if(NOT MSVC AND NOT APPLE AND BUILD_SHARED)
    add_library(nncase_cpu_module SHARED main.cpp)
    set_target_properties(nncase_cpu_module PROPERTIES PREFIX "" SUFFIX "")
    set_target_properties(nncase_cpu_runtime PROPERTIES POSITION_INDEPENDENT_CODE ON)
else()
    add_executable(nncase_cpu_module main.cpp)
endif()
target_compile_features(nncase_cpu_module PUBLIC cxx_std_20)
target_link_libraries(nncase_cpu_module PRIVATE nncase_cpu_runtime)
target_compile_definitions(nncase_cpu_module PUBLIC -DNNCASE_CPU_MODULE=1)

if (MSVC)
    set_target_properties(nncase_cpu_module PROPERTIES LINK_FLAGS /SUBSYSTEM:CONSOLE)
    target_link_options(nncase_cpu_module PRIVATE /ENTRY:kernel_entry /NODEFAULTLIB)
    target_link_libraries(nncase_cpu_module PRIVATE libvcruntime msvcrt)
    set_property(TARGET nncase_cpu_module PROPERTY
        MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
else()
    if (APPLE)
        if(BUILD_STANDALONE)
            target_link_options(nncase_cpu_module PRIVATE -ld_classic -lc)
        else()
            target_link_options(nncase_cpu_module PRIVATE -static)
            target_link_options(nncase_cpu_module PRIVATE -e _kernel_entry -bundle -ld_classic -lc)
            target_compile_options(nncase_cpu_module PRIVATE "$<$<CONFIG:Debug>:-O1>")
        endif(BUILD_STANDALONE)
    else()
        if (BUILD_SHARED)
            target_link_options(nncase_cpu_module PRIVATE -e kernel_entry)
        else()
            target_link_options(nncase_cpu_module PRIVATE -static)
            target_link_options(nncase_cpu_module PRIVATE -e kernel_entry -nostdlib)
        endif()
        set(CMAKE_CXX_FLAGS_RELEASE "-O2 -DNDEBUG") # gcc optimization have bug with nostdlib in O3
        target_link_libraries(nncase_cpu_module PRIVATE gcc)
    endif()
endif()
